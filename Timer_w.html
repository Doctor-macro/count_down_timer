<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>現場向け・多重カウントダウンタイマー (iPad対応)</title>
<style>
  body{background:#fff;color:#000;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;margin:0;padding:0;}
  header{position:sticky;top:0;background:#fff;border-bottom:2px solid #001f3f;padding:10px;z-index:10;}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  button{border:2px solid #001f3f;background:#fff;color:#001f3f;border-radius:8px;padding:5px 6px;font-weight:600;cursor:pointer;min-width:50px;font-size:13px;}
  button:disabled{border-color:#ccc;color:#aaa;cursor:not-allowed;}
  .btn-blue{background:#007BFF;border-color:#007BFF;color:#fff;}
  .btn-danger{border-color:red;color:red;}
  .list{display:grid;grid-auto-flow:column;grid-auto-columns:min-content;gap:16px;padding:16px;}
  .column{display:flex;flex-direction:column;gap:16px;}
  .timer{border:2px solid #001f3f;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:8px;width:300px;}
  .timer input[type=text]{border:1px solid #001f3f;border-radius:6px;padding:3px;width:100%;font-size:15px;}
  .time{font-variant-numeric:tabular-nums;font-size:34px;font-weight:800;text-align:center;margin:10px 0;}
  .presets{display:flex;justify-content:center;gap:6px;flex-wrap:nowrap;}
  .progress{width:100%;height:10px;background:#eee;border:1px solid #001f3f;border-radius:5px;overflow:hidden;}
  .bar{height:100%;width:0;background:#001f3f;transition:width .3s;}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <button id="addTimer" class="btn-blue">＋ 新規タイマー</button>
    <button id="exportCsv">CSV書き出し</button>
    <button id="clearLog" class="btn-danger">ログ全削除</button>
    <button id="enableSound" class="btn-blue">音を有効化/テスト</button>
  </div>
</header>
<main>
  <div class="list" id="list"></div>
</main>
<script>
(() => {
  const listEl = document.getElementById('list');
  const addBtn = document.getElementById('addTimer');
  const exportBtn = document.getElementById('exportCsv');
  const clearBtn = document.getElementById('clearLog');
  const enableSoundBtn = document.getElementById('enableSound');

  // ======= Audio (iOS requires user gesture) =======
  let audioCtx=null, beepInterval=null, unlocked=false;
  function ensureAudio(){
    if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} }
    else if(audioCtx.state==='suspended'){ audioCtx.resume(); }
    unlocked=!!audioCtx; return audioCtx;
  }
  function beepPatternOnce(){
    const ctx=ensureAudio(); if(!ctx) return; const base=ctx.currentTime; const pattern=[1200,1200,1200,1200,1200,1200];
    pattern.forEach((f,i)=>{ const o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(f,base+i*0.16); g.gain.setValueAtTime(0.001,base+i*0.16); g.gain.exponentialRampToValueAtTime(0.16,base+i*0.17); g.gain.exponentialRampToValueAtTime(0.0001,base+i*0.28); o.connect(g).connect(ctx.destination); o.start(base+i*0.16); o.stop(base+i*0.3); });
  }
  function startRepeatingBeep(){ stopRepeatingBeep(); beepPatternOnce(); beepInterval=setInterval(beepPatternOnce,1200); }
  function stopRepeatingBeep(){ if(beepInterval){ clearInterval(beepInterval); beepInterval=null; } }
  enableSoundBtn.addEventListener('click',()=>{ ensureAudio(); beepPatternOnce(); });

  // ======= State (persist) =======
  const LS_KEY='multiTimersUIv1';
  const state={ timers:[], log:[] };
  const save=()=>localStorage.setItem(LS_KEY, JSON.stringify(state));
  const load=()=>{ try{ const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}'); if(Array.isArray(s.timers)) state.timers=s.timers; if(Array.isArray(s.log)) state.log=s.log; }catch(e){} };
  const logEvent=(id,name,type,detail='')=>{ state.log.push({ts:new Date().toISOString(), id, name, type, detail}); if(state.log.length%5===0) save(); };

  // ======= Model =======
  function uid(){ return Math.random().toString(36).slice(2); }
  function fmt(sec){ const s=Math.max(0,Math.floor(sec)); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), r=s%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
  function parseDuration(text){ if(!text) return null; const t=text.trim(); const mm=t.match(/(\d+)m/i); const ss=t.match(/(\d+)s/i); let sec=0; if(mm) sec+=parseInt(mm[1])*60; if(ss) sec+=parseInt(ss[1]); if(!mm&&!ss) sec=parseInt(t)||0; return sec>0? sec : null; }
  function newTimer(total=60){ return { id:uid(), name:'タイマー', total, remain:total, running:false }; }

  // ======= Actions =======
  function action_addTimer(){
    const v=prompt('タイマー時間を入力 (例: 1h, 3m, 90s, 120)'); if(v===null) return; const sec=parseDuration(v); if(!sec){ alert('正しい値を入力してください'); return; }
    const t=newTimer(sec); state.timers.push(t); logEvent(t.id,t.name,'Create',`total=${sec}`); render(); save();
  }
  function action_start(id){ const t=byId(id); if(!t||t.running) return; if(t.remain<=0) t.remain=t.total; t.running=true; logEvent(t.id,t.name,'Start',`remain=${t.remain}`); render(); save(); }
  function action_pause(id){ const t=byId(id); if(!t||!t.running) return; t.running=false; logEvent(t.id,t.name,'Pause',`remain=${t.remain}`); render(); save(); }
  function action_reset(id){ const t=byId(id); if(!t) return; if(!confirm(`「${t.name}」を初期 ${fmt(t.total)} に戻します。よろしいですか？`)) return; t.remain=t.total; t.running=false; logEvent(t.id,t.name,'Reset'); render(); save(); }
  function action_delete(id){ const t=byId(id); if(!t) return; if(!confirm(`「${t.name}」を削除しますか？`)) return; state.timers=state.timers.filter(x=>x.id!==id); logEvent(id,t.name,'Delete'); render(); save(); }
  function action_extend(id,sec){ const t=byId(id); if(!t) return; const before=t.remain; t.remain=Math.max(0,t.remain+sec); const sign=sec>=0?'+':''; logEvent(t.id,t.name,'Extend',`${sign}${sec}s from ${before} to ${t.remain}`); render(); save(); }
  function action_rename(id,val){ const t=byId(id); if(!t) return; const before=t.name; t.name=val||'タイマー'; if(before!==t.name) logEvent(t.id,t.name,'Rename',`from "${before}"`); save(); }
  function byId(id){ return state.timers.find(x=>x.id===id); }

  // ======= Ticker =======
  setInterval(()=>{
    const completed=[];
    state.timers.forEach(t=>{
      if(t.running && t.remain>0){
        t.remain -= 1;
        if(t.remain<=0){ t.remain=0; t.running=false; completed.push(t); logEvent(t.id,t.name,'Completed'); }
      }
    });
    if(completed.length && unlocked){ startRepeatingBeep(); }
    updateBars();
  },1000);

  // ======= Render =======
  function render(){
    listEl.innerHTML='';
    const cols=Math.ceil(state.timers.length/5);
    for(let c=0;c<cols;c++){
      const col=document.createElement('div'); col.className='column';
      state.timers.slice(c*5,c*5+5).forEach(t=>{ col.appendChild(renderTimer(t)); });
      listEl.appendChild(col);
    }
    updateBars();
  }
  function renderTimer(t){
    const d=document.createElement('div'); d.className='timer'; d.dataset.id=t.id;
    d.innerHTML=`
      <input type="text" class="js-name" value="${t.name}" />
      <div class="time js-time">${fmt(t.remain)}</div>
      <div class="presets">
        <button class="btn-blue js-act" data-action="extend" data-sec="3600">+1h</button>
        <button class="btn-blue js-act" data-action="extend" data-sec="600">+10min</button>
        <button class="btn-blue js-act" data-action="extend" data-sec="300">+5min</button>
        <button class="btn-blue js-act" data-action="extend" data-sec="60">+1min</button>
      </div>
      <div class="presets">
        <button class="btn-blue js-act" data-action="extend" data-sec="10">+10sec</button>
        <button class="btn-blue js-act" data-action="extend" data-sec="5">+5sec</button>
        <button class="btn-blue js-act" data-action="extend" data-sec="1">+1sec</button>
        <button class="js-act" data-action="reset">再設定</button>
      </div>
      <div class="progress"><div class="bar js-bar"></div></div>
      <div class="presets">
        <button class="js-act" data-action="start">Start</button>
        <button class="js-act" data-action="pause">Pause</button>
        <button class="js-act" data-action="reset">Reset</button>
        <button class="js-act" data-action="delete">Delete</button>
      </div>`;
    // wire events for this timer
    d.querySelector('.js-name').addEventListener('change', (e)=> action_rename(t.id, e.target.value));
    d.addEventListener('click', (e)=>{
      const btn=e.target.closest('.js-act'); if(!btn) return; const act=btn.dataset.action; const sec=Number(btn.dataset.sec||0);
      switch(act){
        case 'start': action_start(t.id); break;
        case 'pause': action_pause(t.id); break;
        case 'reset': action_reset(t.id); break;
        case 'delete': action_delete(t.id); break;
        case 'extend': action_extend(t.id, sec); break;
      }
    });
    return d;
  }
  function updateBars(){
    // iterate all rendered timers and update time text / bar / button disabled state
    document.querySelectorAll('.timer').forEach(box=>{
      const id=box.dataset.id; const t=byId(id); if(!t) return;
      box.querySelector('.js-time').textContent = fmt(t.remain);
      const bar=box.querySelector('.js-bar'); const pct=t.total>0? Math.max(0, Math.min(100, (1-(t.remain/t.total))*100)) : 0; bar.style.width=pct+'%';
      // buttons enable/disable
      const startBtn=box.querySelector('[data-action="start"]'); const pauseBtn=box.querySelector('[data-action="pause"]');
      if(startBtn) startBtn.disabled = !!t.running;
      if(pauseBtn) pauseBtn.disabled = !t.running;
    });
  }

  // ======= CSV =======
  function toCsv(){ const head='timestamp,timer_id,timer_name,event,detail\n'; const esc=s=>'"'+String(s).replaceAll('"','""')+'"'; const rows=state.log.map(e=>[e.ts,e.id,e.name,e.type,e.detail].map(esc).join(',')); return head+rows.join('\n'); }
  function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1500); }

  addBtn.addEventListener('click', action_addTimer);
  exportBtn.addEventListener('click', ()=>{ if(!state.log.length){ alert('ログがありません'); return; } const ts=new Date().toISOString().replaceAll(':','-').replace('T','_').slice(0,19); download(`timers_log_${ts}.csv`, toCsv()); });
  clearBtn.addEventListener('click', ()=>{ if(!state.log.length){ alert('ログは空です'); return; } if(!confirm('ログをすべて削除しますか？ CSV保存後の削除を推奨します。')) return; state.log=[]; save(); alert('ログを削除しました'); });

  // ======= Init =======
  load(); if(state.timers.length===0){ state.timers.push(newTimer(180)); state.timers.push(newTimer(600)); }
  render();
  window.addEventListener('beforeunload', save);
})();
</script>
</body>
</html>
